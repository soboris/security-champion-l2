<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Confirmation - SecChamp Library</title>
    <div th:replace="~{fragments/topnav :: favicon}"></div>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .checkout-timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: #dc3545;
            border: 2px solid #dc3545;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            background: #fff5f5;
        }
        .order-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #dee2e6;
        }
        .order-item {
            border-bottom: 1px solid #eee;
            padding: 0.75rem 0;
        }
        .order-item:last-child {
            border-bottom: none;
        }
        .credit-info {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .credit-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .confirm-button {
            font-size: 1.2rem;
            padding: 1rem 2rem;
        }
    </style>
</head>
<body>
    <!-- Include navigation -->
    <div th:replace="~{fragments/topnav :: topnav}"></div>

    <!-- FIXED: API Configuration Data Attributes using proper Thymeleaf URL expressions -->
    <div id="apiConfig" style="display: none;"
         th:data-cart-url="@{/cart}"
         th:data-users-url="@{/users}"
         th:data-api-cart-checkout="@{/api/cart/checkout}"
         th:data-api-cart-checkout-confirm="@{/api/cart/checkout/confirm}"
         th:data-api-cart-checkout-cancel="@{/api/cart/checkout/cancel}">
    </div>
    
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2 class="mb-4">Checkout Confirmation</h2>
                
                <!-- Timer Alert -->
                <div class="checkout-timer mb-4">
                    <div>‚è∞ Complete your purchase within:</div>
                    <div id="countdown-timer">05:00</div>
                    <small>Your items are reserved temporarily</small>
                </div>

                <!-- Loading state -->
                <div id="loading" class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading checkout details...</span>
                    </div>
                    <p class="mt-2">Preparing your order...</p>
                </div>

                <!-- Checkout Details -->
                <div id="checkout-details" style="display: none;">
                    <!-- Credit Information -->
                    <div id="credit-info">
                        <!-- Credit info will be populated here -->
                    </div>

                    <!-- Order Summary -->
                    <div class="order-summary mb-4">
                        <h4 class="mb-3">Order Summary</h4>
                        <div id="order-items">
                            <!-- Order items will be populated here -->
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span>Subtotal:</span>
                            <span id="order-subtotal">$0.00</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Shipping:</span>
                            <span class="text-success">FREE</span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Total Amount:</strong>
                            <strong id="order-total">$0.00</strong>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-flex gap-3 justify-content-center">
                        <button id="cancel-btn" class="btn btn-outline-secondary btn-lg">
                            Cancel Order
                        </button>
                        <button id="confirm-btn" class="btn btn-success btn-lg confirm-button">
                            Confirm Purchase
                        </button>
                    </div>
                </div>

                <!-- Error State -->
                <div id="error-message" class="alert alert-danger" style="display: none;" role="alert">
                    <!-- Error message will be shown here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Include navigation script fragment -->
    <div th:replace="~{fragments/topnav :: topnav-script}"></div>

    <script>
        let countdownInterval;
        let checkoutExpiry;

        $(document).ready(function() {
            startCheckout();
            
            // Handle confirm purchase
            $('#confirm-btn').on('click', function() {
                confirmPurchase();
            });
            
            // Handle cancel
            $('#cancel-btn').on('click', function() {
                cancelCheckout();
            });
        });

        function startCheckout() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                showError('Please login to continue with checkout');
                return;
            }

            // FIXED: Get API URL from data attributes
            const apiConfig = $('#apiConfig');
            const checkoutUrl = apiConfig.data('api-cart-checkout');

            $.ajax({
                url: checkoutUrl,
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                success: function(response) {
                    $('#loading').hide();
                    displayCheckoutDetails(response);
                    startCountdown(response.checkoutExpiresIn || 300); // Default 5 minutes
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();
                    console.error('Checkout error:', xhr.responseText);
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message || xhr.responseJSON.error : 'Failed to start checkout';
                    showError(errorMsg);
                }
            });
        }

        function displayCheckoutDetails(data) {
            // Display credit information
            const currentCredit = data.remainingCredit || 0;
            const totalPrice = data.totalPrice || 0;
            const afterPurchaseCredit = currentCredit;
            
            let creditHtml = '';
            if (currentCredit >= totalPrice) {
                creditHtml = `
                    <div class="credit-info">
                        <h5>üí≥ Credit Information</h5>
                        <div class="d-flex justify-content-between">
                            <span>Current Credit Limit:</span>
                            <strong>$${currentCredit.toFixed(2)}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>After Purchase:</span>
                            <strong class="text-success">$${afterPurchaseCredit.toFixed(2)}</strong>
                        </div>
                    </div>
                `;
            } else {
                creditHtml = `
                    <div class="credit-warning">
                        <h5>‚ö†Ô∏è Insufficient Credit</h5>
                        <div class="d-flex justify-content-between">
                            <span>Current Credit Limit:</span>
                            <strong>$${currentCredit.toFixed(2)}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Required:</span>
                            <strong class="text-danger">$${totalPrice.toFixed(2)}</strong>
                        </div>
                        <small class="text-muted">Contact support to increase your credit limit.</small>
                    </div>
                `;
            }
            $('#credit-info').html(creditHtml);

            // Display order items
            let itemsHtml = '';
            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    itemsHtml += `
                        <div class="order-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${item.title}</h6>
                                    <small class="text-muted">by ${item.author}</small>
                                </div>
                                <div class="text-end">
                                    <div>$${item.price.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            $('#order-items').html(itemsHtml);
            $('#order-subtotal').text('$' + totalPrice.toFixed(2));
            $('#order-total').text('$' + totalPrice.toFixed(2));

            // Disable confirm button if insufficient credit
            if (currentCredit < totalPrice) {
                $('#confirm-btn').prop('disabled', true).text('Insufficient Credit');
            }

            $('#checkout-details').show();
        }

        function startCountdown(seconds) {
            checkoutExpiry = Date.now() + (seconds * 1000);
            
            countdownInterval = setInterval(function() {
                const remaining = Math.max(0, checkoutExpiry - Date.now());
                const minutes = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                
                $('#countdown-timer').text(
                    String(minutes).padStart(2, '0') + ':' + String(secs).padStart(2, '0')
                );
                
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    showError('Checkout session expired. Please try again.');
                    // FIXED: Get cart URL from data attributes
                    const apiConfig = $('#apiConfig');
                    const cartUrl = apiConfig.data('cart-url');
                    setTimeout(() => {
                        window.location.href = cartUrl;
                    }, 3000);
                }
            }, 1000);
        }

        function confirmPurchase() {
            const token = localStorage.getItem('authToken');
            
            // Disable button and show loading
            $('#confirm-btn').prop('disabled', true).text('Processing Purchase...');
            
            // FIXED: Get API URL from data attributes
            const apiConfig = $('#apiConfig');
            const confirmUrl = apiConfig.data('api-cart-checkout-confirm');
            const usersUrl = apiConfig.data('users-url');
            
            $.ajax({
                url: confirmUrl,
                type: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                success: function(response) {
                    clearInterval(countdownInterval);
                    alert('üéâ Purchase successful! Your books have been added to your library.');
                    
                    // Update cart count in navigation
                    if (window.updateCartCount) {
                        window.updateCartCount();
                    }
                    
                    // Redirect to My Library
                    window.location.href = usersUrl;
                },
                error: function(xhr, status, error) {
                    console.error('Purchase confirmation error:', xhr.responseText);
                    const errorMsg = xhr.responseJSON ? xhr.responseJSON.message || xhr.responseJSON.error : 'Purchase failed';
                    
                    // Re-enable button
                    $('#confirm-btn').prop('disabled', false).text('Confirm Purchase');
                    
                    showError(errorMsg);
                }
            });
        }

        function cancelCheckout() {
            if (confirm('Are you sure you want to cancel this checkout?')) {
                const token = localStorage.getItem('authToken');
                
                // FIXED: Get API URL from data attributes
                const apiConfig = $('#apiConfig');
                const cancelUrl = apiConfig.data('api-cart-checkout-cancel');
                const cartUrl = apiConfig.data('cart-url');
                
                $.ajax({
                    url: cancelUrl,
                    type: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    complete: function() {
                        clearInterval(countdownInterval);
                        window.location.href = cartUrl;
                    }
                });
            }
        }

        function showError(message) {
            $('#checkout-details').hide();
            
            // FIXED: Get cart URL from data attributes
            const apiConfig = $('#apiConfig');
            const cartUrl = apiConfig.data('cart-url');
            
            $('#error-message').html(`
                <h5>Error</h5>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="window.location.href='${cartUrl}'">
                    Return to Cart
                </button>
            `).show();
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
        }

        // Clean up interval on page unload
        $(window).on('beforeunload', function() {
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
        });
    </script>
</body>
</html>
